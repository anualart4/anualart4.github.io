<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Art Geomètric Amb Expressió Facial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
    <style>
        /* Estil general del cos de la pàgina */
        body {
            margin: 0; /* sense marges externs */
            padding: 0; /* sense espais interns */
            background-color: #f4f4f4; /* color de fons gris clar */
            display: flex; /* fa servir flexbox per alinear */
            justify-content: center; /* centra horitzontalment */
            align-items: center; /* centra verticalment */
            height: 100vh; /* alçada de tota la pantalla */
        }

        /* Pantalla de càrrega quan els models encara es carreguen */
        #loading-screen {
            position: fixed; /* fixa la posició a la pantalla */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9); /* blanc amb transparència */
            display: flex;
            flex-direction: column; /* columna vertical */
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #333; /* gris fosc */
            z-index: 10; /* per sobre de tot */
        }

        /* Rodona animada de càrrega */
        .loader {
            width: 50px;
            height: 50px;
            border: 6px solid #3498db; /* blau */
            border-top: 6px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        /* Animació de gir */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
        <p>Carregant models, si us plau, espera...</p>
    </div>
    <script>
        // Variables globals
        let faceapi, detections = [], video;
        let modelsMostrats = false;

        // Mida virtual que es manté proporcional a qualsevol pantalla
        const VIRTUAL_W = 600;
        const VIRTUAL_H = 703;

        // Funció que es crida al començar
        function setup() {
            createCanvas(windowWidth, windowHeight); // crea una zona de dibuix de la mida de la finestra
            video = createCapture(VIDEO);             // activa la webcam
            video.size(480, 480);                     // estableix la mida del vídeo
            video.hide();                             // amaga el vídeo per defecte

            // Configura els paràmetres del reconeixement facial
            const options = {
                withLandmarks: true,
                withExpressions: true,
                withDescriptors: false
            };
            faceapi = ml5.faceApi(video, options, modelReady); // inicialitza el model amb la webcam
        }

        // Redimensiona el canvas si canvia la mida de la finestra
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        // Quan el model està carregat correctament
        function modelReady() {
            faceapi.detect(gotResults); // comença a detectar cares
        }

        // Quan hi ha resultats del model
        function gotResults(err, result) {
            if (err) return console.error(err); // mostra error si hi ha
            detections = result; // desa les dades de la detecció
            if (!modelsMostrats) {
                document.getElementById("loading-screen").style.display = "none";
                modelsMostrats = true;
            }
            faceapi.detect(gotResults); // torna a detectar de forma continua
        }

        // Funció de dibuix
        function draw() {
            background(255); // fons blanc

            // Inicialitzem l'estat emocional detectat
            let dominant = "neutral", intensity = 0;
            if (detections.length > 0) {
                let expr = detections[0].expressions;
                dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
                intensity = expr[dominant];
            }

            // Calcular escala i marges per centrar el dibuix virtual a la pantalla
            let scaleFactor = min(width / VIRTUAL_W, height / VIRTUAL_H);
            let offsetX = (width - VIRTUAL_W * scaleFactor) / 2;
            let offsetY = (height - VIRTUAL_H * scaleFactor) / 2;

            // Aplicar transformacions per mantenir el dibuix centrat i escalat
            push(); // desa l'estat de transformació
            translate(offsetX, offsetY); // desplaça l'origen
            scale(scaleFactor); // redimensiona proporcionalment
            drawArt(dominant, intensity); // dibuixa la figura segons l'expressió
            pop(); // recupera l'estat anterior

            // Mostra el text amb l'expressió dominant (fora de transformacions)
            noStroke();
            fill(44,169,225);
            textSize(32);
            textAlign(CENTER, TOP);
            text("Expressió: " + dominant, width / 2, 10);

            // Mostra el vídeo si hi ha detecció
            if (detections.length > 0) {
                image(video, width - 140, height - 140, 120, 120);
            }
        }

        // Dibuixa diferents figures depenent de l'estat emocional
        function drawArt(dominant, intensity) {
            noFill();
            strokeWeight(4);

            switch (dominant) {
                case 'happy':
                    stroke(255,200,0); // groc
                    beginShape();//cap
                    vertex(288.0028409957886, 125.09090805053711);
                    vertex(259.0028409957886, 135.0909080505371);
                    vertex(231.00284099578857, 150.0909080505371);
                    vertex(212.00284099578857, 179.0909080505371);
                    vertex(196.00284099578857, 215.0909080505371);
                    vertex(193.00284099578857, 229.72727394104004);
                    vertex(191.00284099578857, 240.72727394104004);
                    vertex(191.00284099578857, 257.72727394104004);
                    vertex(191.00284099578857, 276.72727394104004);
                    vertex(186.00284099578857, 297.72727394104004);
                    vertex(191.00284099578857, 321.72727394104004);
                    vertex(195.00284099578857, 349.72727394104004);
                    vertex(207.00284099578857, 382.72727394104004);
                    vertex(213.00284099578857, 403.72727394104004);
                    vertex(223.00284099578857, 413.72727394104004);
                    vertex(244.00284099578857, 422.72727394104004);
                    vertex(263.0028409957886, 418.7272644042969);
                    vertex(279
